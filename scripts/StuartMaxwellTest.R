StuartMaxwellTest <- function (x, y = NULL) {

  # stuart.maxwell.mh computes the marginal homogeneity test for
  # a CxC matrix of assignments of objects to C categories or an
  # nx2 or 2xn matrix of category scores for n data objects by two
  # raters. The statistic is distributed as Chi-square with C-1
  # degrees of freedom.

  # The core code is form Jim Lemon, package concord
  # the intro is taken from mcnemar.test (core)

  if (is.matrix(x)) {
    r <- nrow(x)
    if ((r < 2) || (ncol(x) != r))
      stop("'x' must be square with at least two rows and columns")
    if (any(x < 0) || anyNA(x))
      stop("all entries of 'x' must be nonnegative and finite")
    DNAME <- deparse(substitute(x))
  }
  else {
    if (is.null(y))
      stop("if 'x' is not a matrix, 'y' must be given")
    if (length(x) != length(y))
      stop("'x' and 'y' must have the same length")
    DNAME <- paste(deparse(substitute(x)), "and", deparse(substitute(y)))
    OK <- complete.cases(x, y)
    x <- as.factor(x[OK])
    y <- as.factor(y[OK])
    r <- nlevels(x)
    if ((r < 2) || (nlevels(y) != r))
      stop("'x' and 'y' must have the same number of levels (minimum 2)")
    x <- table(x, y)
  }

  # get the marginals
  rowsums <- rowSums(x)
  colsums <- colSums(x)
  equalsums <- rowsums == colsums

  if(any(equalsums)) {
    # dump any categories with perfect agreement
    x <- x[!equalsums, !equalsums]
    # bail out if too many categories have disappeared
    if(dim(x)[1] < 2) stop("Too many equal marginals, cannot compute")
    # get new marginals
    rowsums <- rowSums(x)
    colsums <- colSums(x)
  }

  # use K-1 marginals
  Kminus1 <- length(rowsums) - 1
  smd <- (rowsums-colsums)[1:Kminus1]
  smS <- matrix(0, nrow=Kminus1, ncol=Kminus1)
  for(i in 1:Kminus1) {
    for(j in 1:Kminus1) {
      if(i == j) smS[i,j] <- rowsums[i] + colsums[j] - 2 * x[i,j]
      else smS[i,j] <- -(x[i,j] + x[j,i])
    }
  }

  STATISTIC <- t(smd) %*% solve(smS) %*% smd

  PARAMETER <- r - 1
  METHOD <- "Stuart-Maxwell test"

  PVAL <- pchisq(STATISTIC, PARAMETER, lower.tail = FALSE)
  names(STATISTIC) <- "chi-squared"
  names(PARAMETER) <- "df"
  RVAL <- list(statistic = STATISTIC, parameter = PARAMETER,
               p.value = PVAL, method = METHOD, data.name = DNAME)
  class(RVAL) <- "htest"
  return(RVAL)

}

# mayo

mc <- as.table(matrix(c(128398, 490, 1, 1351, 229, 32,
+ 12, 1079, 869, 4, 5, 3, 130, 1168, 47472, 45, 1438,
+ 354, 976, 35, 321, 479, 14, 17, 27, 363, 0, 7, 33674,
+ 393, 73, 7, 1, 0, 75, 1, 0, 1, 12, 1668, 1881, 365, 240544,
+ 5122, 3081, 2278, 436, 211, 3153, 459, 143, 4571, 3, 18, 0, 13627,
+ 103602, 0, 13, 177, 1, 21, 2, 32, 226, 484, 1533, 150, 4310, 270,
+ 59308, 52, 169, 43, 1347, 271, 16, 1420, 4, 80, 0, 21, 9, 1, 0,
+ 5, 11, 47, 1, 40, 10, 1208, 158, 0, 558, 885, 4, 3, 14244, 0, 22,
+ 3, 20, 71, 590, 87, 115, 967, 122, 149, 0, 22, 111988, 1, 0, 207,
+ 34, 221, 143, 24, 518, 335, 23, 56, 11, 15, 12744, 43, 16, 79, 8, 17,
+ 1, 231, 212, 13, 5, 7, 0, 338, 105, 15, 91, 15, 23, 0, 562, 485, 4, 1,
+ 50, 7, 36, 1, 61086, 67, 248, 415, 79, 5663, 1256, 814, 112, 146, 29, 171,
+ 130, 92, 155777), nrow=13))
StuartMaxwellTest(mc)

# Result
#data:  mc
#chi-squared = 7427.4, df = 12, p-value < 2.2e-16

# ontonotes

mc <- as.table(matrix(c(255929, 1290, 37, 2696, 230, 94, 14, 1969, 1686, 5, 5, 3, 171, 2258, 95424, 121, 2435, 368, 2252, 44, 603, 1218, 23, 27, 73, 561, 15, 77, 67659, 817, 75, 45, 8, 0, 196, 1, 0, 1, 20, 2329, 2132, 526, 481364, 5541, 9641, 2342, 1279, 1925, 3448, 546, 1437, 8630, 4, 18, 0, 26760, 221031, 35, 14, 178, 30, 23, 6, 37, 243, 641, 2731, 210, 7965, 292, 128673, 63, 351, 302, 1393, 354, 118, 3520, 43, 164, 11, 91, 9, 34, 541, 7, 137, 65, 1, 55, 47, 2588, 359, 0, 712, 900, 47, 4, 31317, 12, 22, 7, 21, 87, 1152, 230, 216, 1965, 123, 214, 1, 22, 225659, 1, 0, 283, 49, 277, 156, 58, 1390, 371, 290, 57, 34, 100, 25532, 70, 94, 177, 23, 21, 3, 333, 212, 35, 86, 8, 15, 440, 105, 25, 109, 15, 30, 6, 1025, 488, 22, 1, 51, 12, 140, 1, 123217, 81, 306, 490, 109, 9453, 1333, 1827, 132, 163, 266, 189, 140, 125, 315565), nrow=13))
StuartMaxwellTest(mc)
# Result
# 	Stuart-Maxwell test
#
# data:  mc
# chi-squared = 11360, df = 12, p-value < 2.2e-16

# hepple

mc <- as.table(matrix(c(865208, 2884, 75, 8662, 246, 296, 15, 4002, 5013, 14, 15, 8, 246, 6076, 330840, 364, 5349, 424, 8192, 76, 2390, 2590, 306, 68, 259, 1171, 52, 425, 236699, 2739, 77, 95, 8, 12, 453, 6, 0, 1, 32, 9282, 8423, 3745, 1692066, 7657, 23636, 5162, 8563, 9823, 13211, 6075, 5207, 25645, 8, 20, 0, 91865, 802622, 36, 14, 322, 34, 24, 9, 41, 247, 2750, 9287, 582, 23610, 534, 476446, 714, 3069, 5311, 7216, 3292, 1001, 8974, 56, 965, 11, 262, 180, 207, 696, 8, 355, 419, 86, 188, 92, 4658, 1406, 0, 1810, 1119, 56, 4, 163459, 12, 22, 7, 21, 88, 3339, 612, 663, 6590, 123, 751, 1, 22, 796680, 5, 0, 544, 68, 1100, 622, 157, 4100, 447, 713, 212, 459, 579, 90485, 473, 402, 653, 142, 85, 18, 761, 232, 108, 144, 19, 44, 2167, 357, 53, 150, 29, 49, 10, 2801, 492, 54, 8, 73, 56, 384, 10, 433793, 107, 850, 856, 277, 25151, 1773, 5178, 214, 513, 588, 640, 534, 335, 1113488), nrow=13))
StuartMaxwellTest(mc)
# Result
# Stuart-Maxwell test
#
# data:  mc
# chi-squared = 86744, df = 12, p-value < 2.2e-16

# Mate
mc <- as.table(matrix(c(1228539, 4178, 195, 12439, 261, 449, 20, 5479, 7116, 69, 46, 33, 400, 8632, 472912, 574, 7694, 662, 11745, 132, 3738, 3961, 487, 169, 457, 1604, 105, 699, 337663, 3912, 80, 189, 10, 21, 549, 19, 4, 4, 41, 10922, 13095, 5420, 2403582, 12155, 30620, 5933, 13192, 15210, 16941, 8521, 8951, 36258, 70, 490, 389, 137221, 1162069, 1024, 347, 1553, 83, 610, 282, 162, 2608, 3268, 13301, 824, 35117, 3440, 666729, 1043, 5512, 8215, 8204, 3947, 1378, 12662, 64, 1493, 37, 822, 232, 299, 705, 12, 750, 824, 94, 240, 141, 6667, 2120, 12, 2492, 1246, 78, 6, 243286, 14, 30, 9, 27, 110, 4791, 1258, 693, 9512, 130, 1189, 1, 25, 1141916, 29, 15, 697, 98, 1441, 1046, 323, 5779, 678, 894, 258, 658, 955, 129615, 666, 609, 1067, 170, 99, 39, 1190, 283, 150, 147, 37, 52, 2515, 388, 63, 181, 46, 75, 26, 4077, 545, 87, 10, 95, 206, 771, 87, 620122, 156, 1128, 1334, 491, 37100, 3427, 7514, 330, 751, 1230, 886, 831, 649, 1587459), nrow=13))
StuartMaxwellTest(mc)

# Result

#	Stuart-Maxwell test

#data:  mc
#chi-squared = 129135, df = 12, p-value < 2.2e-16


# maxent
mc <- as.table(matrix(c(1107412, 3835, 170, 11116, 260, 398, 15, 4907, 6227, 50, 31, 18, 334, 8056, 426397, 570, 6930, 662, 10960, 102, 3421, 3365, 458, 153, 309, 1466, 97, 624, 304108, 3505, 79, 119, 9, 18, 548, 10, 4, 3, 38, 10496, 10351, 5342, 2164407, 11869, 27686, 5675, 12429, 11608, 16655, 6996, 5809, 32463, 70, 486, 389, 124091, 1045082, 1023, 345, 1490, 83, 610, 280, 161, 2608, 3104, 12059, 816, 30699, 3421, 606857, 1007, 5430, 6318, 8124, 3845, 1240, 11854, 57, 1375, 37, 675, 232, 290, 704, 8, 639, 698, 94, 218, 122, 6106, 1896, 12, 2249, 1183, 68, 4, 216172, 13, 27, 9, 21, 98, 4373, 866, 692, 8497, 129, 987, 1, 24, 1023841, 12, 12, 665, 75, 1296, 706, 321, 5189, 665, 807, 244, 630, 691, 116669, 593, 484, 1017, 170, 98, 39, 1155, 283, 150, 147, 37, 51, 2325, 388, 61, 180, 45, 59, 24, 3619, 533, 83, 9, 92, 191, 714, 78, 558012, 143, 1031, 996, 447, 31957, 3411, 6778, 274, 629, 682, 815, 627, 432, 1426503), nrow=13))
StuartMaxwellTest(mc)

# Result

#	Stuart-Maxwell test

#data:  mc
#chi-squared = 112632, df = 12, p-value < 2.2e-16

# perceptron
mc <- as.table(matrix(c(986028, 3347, 87, 9823, 258, 342, 15, 4455, 5633, 14, 15, 9, 272, 7033, 378587, 397, 6052, 645, 9555, 89, 2934, 3002, 326, 74, 292, 1353, 73, 537, 270376, 3111, 78, 119, 9, 18, 503, 6, 0, 1, 35, 9456, 9175, 4122, 1921753, 11598, 25409, 5472, 10468, 9934, 14338, 6330, 5353, 29994, 64, 479, 376, 110943, 927729, 1018, 345, 1429, 80, 607, 280, 161, 2600, 2850, 10770, 671, 26763, 3381, 540562, 952, 3373, 5380, 7386, 3657, 1048, 10601, 56, 1114, 29, 469, 232, 234, 704, 8, 492, 553, 86, 193, 104, 5460, 1673, 0, 2030, 1134, 62, 4, 189962, 12, 23, 7, 21, 89, 3866, 740, 674, 7541, 128, 914, 1, 23, 910200, 5, 0, 610, 69, 1117, 669, 175, 4586, 632, 759, 237, 565, 579, 103507, 511, 457, 972, 160, 94, 28, 911, 275, 119, 145, 24, 44, 2210, 359, 55, 171, 31, 50, 11, 3206, 530, 77, 9, 92, 99, 567, 70, 495868, 130, 909, 925, 296, 28507, 3399, 5893, 267, 604, 595, 681, 569, 376, 1268078), nrow=13))
StuartMaxwellTest(mc)

# Result

#	Stuart-Maxwell test

#data:  mc
# chi-squared = 95124, df = 12, p-value < 2.2e-16

# st-csls
mc <- as.table(matrix(c(620617, 2246, 75, 6271, 244, 218, 15, 3295, 3715, 12, 15, 7, 232, 4670, 235991, 262, 4248, 410, 5946, 44, 1927, 2031, 119, 51, 199, 989, 45, 277, 169093, 2007, 77, 48, 8, 12, 414, 2, 0, 1, 29, 7010, 6856, 634, 1198455, 7291, 18387, 2379, 8049, 2796, 11789, 3797, 2716, 20088, 8, 20, 0, 66066, 573347, 36, 14, 217, 34, 24, 9, 41, 245, 2030, 6789, 227, 17745, 458, 338553, 66, 3011, 421, 6702, 2872, 498, 7152, 46, 655, 11, 160, 180, 135, 541, 8, 273, 211, 68, 119, 76, 3690, 946, 0, 1372, 1036, 56, 4, 112440, 12, 22, 7, 21, 87, 2642, 461, 611, 4720, 123, 589, 1, 22, 568176, 1, 0, 544, 52, 738, 506, 63, 2995, 423, 554, 59, 427, 149, 64777, 402, 328, 543, 127, 63, 10, 683, 232, 93, 86, 17, 42, 1550, 278, 33, 145, 21, 41, 6, 2093, 490, 43, 1, 73, 41, 224, 9, 309468, 106, 617, 693, 153, 18986, 1683, 4123, 149, 510, 368, 527, 519, 287, 795693), nrow=13))
StuartMaxwellTest(mc)

# Result

#	Stuart-Maxwell test

#data:  mc
# chi-squared = 54335, df = 12, p-value < 2.2e-16


# st-fast
mc <- as.table(matrix(c(743199, 2579, 75, 7475, 246, 261, 15, 3725, 4426, 13, 15, 8, 246, 5457, 283420, 314, 4907, 421, 7120, 71, 2184, 2323, 231, 51, 238, 1047, 52, 390, 202843, 2371, 77, 85, 8, 12, 444, 6, 0, 1, 32, 8098, 7442, 1164, 1444524, 7479, 20466, 4696, 8072, 6674, 12647, 3947, 4772, 23554, 8, 20, 0, 78966, 686757, 36, 14, 246, 34, 24, 9, 41, 246, 2202, 8241, 350, 21277, 483, 407179, 646, 3012, 3272, 6960, 2880, 742, 8352, 52, 848, 11, 259, 180, 183, 674, 8, 324, 270, 68, 160, 92, 4165, 1116, 0, 1598, 1089, 56, 4, 138101, 12, 22, 7, 21, 88, 3082, 539, 627, 5638, 123, 723, 1, 22, 682149, 5, 0, 544, 55, 913, 526, 108, 3623, 427, 600, 191, 442, 411, 77671, 408, 394, 600, 131, 68, 17, 741, 232, 106, 144, 18, 44, 1589, 278, 48, 150, 23, 41, 7, 2456, 492, 53, 7, 73, 47, 251, 9, 371608, 107, 826, 782, 253, 22090, 1771, 4819, 207, 511, 523, 620, 519, 322, 954617), nrow=13))
StuartMaxwellTest(mc)

# Result

#	Stuart-Maxwell test

#data:  mc
#chi-squared = 70360, df = 12, p-value < 2.2e-16



# st-wsj
mc <- as.table(matrix(c(377594, 1650, 49, 3886, 230, 133, 15, 2385, 2295, 12, 5, 7, 190, 3031, 142370, 156, 3022, 372, 3507, 44, 1120, 1455, 61, 27, 86, 646, 23, 162, 101332, 1238, 75, 46, 8, 12, 242, 1, 0, 1, 22, 3627, 2435, 599, 719977, 5617, 13052, 2379, 7887, 2164, 5135, 663, 1896, 12147, 4, 18, 0, 39856, 338454, 35, 14, 191, 30, 24, 6, 37, 244, 1243, 3952, 224, 11285, 319, 199060, 66, 2975, 353, 1554, 515, 212, 4673, 46, 333, 11, 100, 11, 69, 541, 8, 182, 163, 3, 102, 56, 2940, 577, 0, 931, 946, 50, 4, 58341, 12, 22, 7, 21, 87, 1685, 317, 251, 2880, 123, 337, 1, 22, 339954, 1, 0, 309, 51, 416, 190, 63, 1944, 388, 404, 59, 417, 107, 38681, 80, 167, 287, 59, 25, 5, 454, 212, 51, 86, 17, 17, 803, 131, 28, 110, 15, 30, 6, 1382, 488, 28, 1, 71, 12, 163, 1, 185357, 86, 416, 543, 151, 12474, 1371, 2519, 149, 490, 275, 306, 149, 207, 475860), nrow=13))
StuartMaxwellTest(mc)

# Result

#	Stuart-Maxwell test

#data:  mc
# chi-squared = 26435, df = 12, p-value < 2.2e-16